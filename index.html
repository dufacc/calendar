<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<link rel="icon" type="image/png" sizes="32x32" href="files/icon/favicon1.png">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CalendÃ¡rio de Advento</title>
<style>
body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background: url('https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExa2hyaHplbGYxdGE4ZXEzc3F6dmttYzJwNXFraG02a3ZoM2JmZDJsbiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/BDucPOizdZ5AI/giphy.gif');
    background-size: cover;
    background-attachment: fixed;
    color: #fff;
}
h1 {
    text-align: center;
    margin-top: 20px;
    font-size: 40px;
    text-shadow: 2px 2px 4px #000;
}
.grid {
    width: 90%;
    margin: 40px auto;
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-auto-rows: 120px;
    gap: 12px;
}
.day-box {
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.6s;
    cursor: pointer;
}
.day-inner {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    border-radius: 10px;
    font-weight: bold;
    font-size: 20px;
    border: 2px solid rgba(255,255,255,0.75);
    backface-visibility: hidden;
    opacity: 0.75;
}
.day-back {
    transform: rotateY(180deg);
    background-size: cover;
    background-position: center;
    border-radius: 10px;
}
.flipped {
    transform: rotateY(180deg);
}
.today-front {
    background: #C62828 !important;
    color: #fff !important;
    border-color: #fff !important;
}
.open-front {
    color: #222 !important;
}
.locked-front {
    color: #fff;
}
.wide { grid-column: span 2; }
.tall { grid-row: span 2; }
.big { grid-column: span 2; grid-row: span 2; }
#popupBg {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
}
#popup {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 320px;
    text-align: center;
    color: #000;
}
#musicBtn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 15px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-size: 18px;
    z-index: 100;
}
</style>
</head>
<body>
<h1>ğŸ„ CalendÃ¡rio de Advento</h1>
<div class="grid" id="grid"></div>
<div id="popupBg"><div id="popup"></div></div>

<!-- Som do flip -->
<audio id="flipSound" src="files/audio/flipcard.mp3"></audio>
<!-- Ãudio do popup -->
<audio id="popupAudio"></audio>

<!-- Seamless loop para bgmusic (dois players) -->
<audio id="bgMusic1" src="files/audio/bgmusic.mp3" preload="auto"></audio>
<audio id="bgMusic2" src="files/audio/bgmusic.mp3" preload="auto"></audio>

<button id="musicBtn" onclick="toggleMusic()">ğŸ”‡ MÃºsica</button>

<script>
const grid = document.getElementById("grid");
const now = new Date();
const today = now.getDate();
const TOTAL = 24;
const AUTO_OPEN_PAST_DAYS = false;

// Elementos de Ã¡udio
const bgMusic1 = document.getElementById("bgMusic1");
const bgMusic2 = document.getElementById("bgMusic2");
const flipSound = document.getElementById("flipSound");
const popupAudio = document.getElementById("popupAudio");
const musicBtn = document.getElementById("musicBtn");

let originalVolume = 0.5;
let musicEnabled = false; // ComeÃ§a sem som (muted)
let firstInteraction = true;

// Seamless loop com dois players
function startSeamlessLoop() {
    bgMusic1.volume = 0;
    bgMusic2.volume = 0;
    bgMusic1.play();
    bgMusic2.play();

    bgMusic1.addEventListener('timeupdate', function() {
        if (bgMusic1.currentTime > bgMusic1.duration - 0.2) {
            bgMusic2.currentTime = 0;
            bgMusic2.play();
        }
    });
    bgMusic2.addEventListener('timeupdate', function() {
        if (bgMusic2.currentTime > bgMusic2.duration - 0.2) {
            bgMusic1.currentTime = 0;
            bgMusic1.play();
        }
    });
}

// Fade in/out suave
function fadeVolume(audio, targetVol, duration = 800) {
    const steps = 20;
    const interval = duration / steps;
    const step = (targetVol - audio.volume) / steps;
    let currentStep = 0;

    const fadeInterval = setInterval(() => {
        currentStep++;
        audio.volume = Math.min(1, Math.max(0, audio.volume + step));
        if (currentStep >= steps) {
            audio.volume = targetVol;
            clearInterval(fadeInterval);
        }
    }, interval);
}

// Ativa a mÃºsica com fade-in na primeira interaÃ§Ã£o
function enableMusic() {
    if (musicEnabled) return;
    musicEnabled = true;
    fadeVolume(bgMusic1, originalVolume, 1500);
    fadeVolume(bgMusic2, originalVolume, 1500);
    musicBtn.textContent = "ğŸ”Š MÃºsica";
}

// Reduz volume da mÃºsica de fundo (efeitos)
function reduceBgVolume() {
    fadeVolume(bgMusic1, 0.15, 600);
    fadeVolume(bgMusic2, 0.15, 600);
}
function restoreBgVolume() {
    if (musicEnabled) {
        fadeVolume(bgMusic1, originalVolume, 1000);
        fadeVolume(bgMusic2, originalVolume, 1000);
    }
}

// Toggle manual da mÃºsica
function toggleMusic() {
    if (musicEnabled) {
        fadeVolume(bgMusic1, 0, 800);
        fadeVolume(bgMusic2, 0, 800);
        musicEnabled = false;
        musicBtn.textContent = "ğŸ”‡ MÃºsica";
    } else {
        enableMusic();
    }
}

// Inicia o loop seamless assim que a pÃ¡gina carrega
startSeamlessLoop();

// Mensagens, imagens e Ã¡udios personalizados
const mensagens = {
    1: "Primeiro dia! ğŸ‰",
    2: "Surpresa do dia 2!",
    5: "Mensagem exclusiva do dia 5!",
    10: "Faltam 14 dias para o Natal! ğŸ„",
    20: "Dia 20, reta final! â­",
    24: "Chegou a vÃ©spera! ğŸ…âœ¨"
};
const imagens = {
    1: "https://picsum.photos/id/237/500/500",
    5: "https://picsum.photos/id/1025/500/500",
    10: "https://picsum.photos/id/1062/500/500"
};
const audios = {
    1: "dia1",
    5: "dia5",
    10: "dia10",
    24: "dia24"
};

const greenPalette = ["#1B5E20","#2E7D32","#388E3C","#43A047","#66BB6A","#A5D6A7"];
const emojis = ["âœ¨","ğŸ","ğŸ„","â­","â„ï¸","â›„","ğŸ•¯ï¸","ğŸª","ğŸŒŸ","ğŸ¦Œ","ğŸ””","â¤ï¸"];
const formats = [
    { name: "square", w: 1, h: 1 },
    { name: "wide", w: 2, h: 1 },
    { name: "tall", w: 1, h: 2 },
    { name: "big", w: 2, h: 2 },
];

function createColorForDay(day){
    return greenPalette[(day-1) % greenPalette.length];
}

function createBox(day, format){
    const wrapper = document.createElement("div");
    wrapper.classList.add("day-box");
    if (format.name !== "square") wrapper.classList.add(format.name);

    const front = document.createElement("div");
    front.classList.add("day-inner");
    const back = document.createElement("div");
    back.classList.add("day-inner","day-back");

    const imgBack = imagens[day] || `https://picsum.photos/300?random=${day}`;
    back.style.backgroundImage = `url('${imgBack}')`;

    const baseColor = createColorForDay(day);
    const emoji = emojis[Math.floor(Math.random() * emojis.length)];

    if (day < today && AUTO_OPEN_PAST_DAYS) {
        wrapper.classList.add("flipped");
        front.classList.add("open-front");
        front.style.background = baseColor;
        front.style.color = "#fff";
        front.innerHTML = `DIA ${day} ${emoji}`;
    } else if (day === today) {
        front.classList.add("today-front");
        if (day === 24) {
            front.innerHTML = `ğŸ•¯ï¸ DIA 24 ğŸ… <br><small style="font-size:14px; display:block; margin-top:4px;">â„ï¸ğŸ„ A magia estÃ¡ no ar! âœ¨ Que esta vÃ©spera de Natal encha seu mundo de paz, alegria e sonhos brilhando! ğŸŒŸğŸ</small>`;
        } else {
            front.innerHTML = `ğŸ•¯ï¸ DIA ${day} ğŸ… <br><small style="font-size:14px; display:block; margin-top:4px;">Ã‰ hoje! ğŸ Abra sua janelinha!</small>`;
        }
    } else {
        front.classList.add("locked-front");
        front.style.background = baseColor;
        front.style.color = "#fff";
        front.innerHTML = `DIA ${day} ${emoji}`;
    }

    wrapper.appendChild(front);
    wrapper.appendChild(back);

    wrapper.addEventListener("click", () => {
        // Primeira interaÃ§Ã£o: ativa a mÃºsica com fade-in
        if (firstInteraction) {
            firstInteraction = false;
            enableMusic();
        }

        if (day > today) {
            showPopupMsg(`Ainda nÃ£o Ã© dia ${day} para abrir esta surpresa!`);
            return;
        }
        if (!wrapper.classList.contains("flipped")) {
            wrapper.classList.add("flipped");
            reduceBgVolume();
            flipSound.currentTime = 0;
            flipSound.play().catch(() => {});
            setTimeout(restoreBgVolume, 800);
        } else {
            showPopup(day);
        }
    });
    return wrapper;
}

function showPopup(day){
    const bg = document.getElementById("popupBg");
    const p = document.getElementById("popup");
    const imgUrl = imagens[day] || `https://picsum.photos/500?random=${day}`;
    const mensagem = mensagens[day] || "Mensagem especial!";
    const audioName = audios[day];

    p.innerHTML = `
        <h2>Dia ${day}</h2>
        <img src="${imgUrl}" style="width:100%;border-radius:10px;margin-bottom:15px;" />
        <p>${mensagem}</p>
        <button onclick="closePopup()">Fechar</button>
    `;
    bg.style.display = "flex";

    if (audioName) {
        popupAudio.src = `files/audio/cards/${audioName}.mp3`;
        popupAudio.load();
        reduceBgVolume();
        popupAudio.play().catch(() => {});
        popupAudio.onended = () => restoreBgVolume();
    }
}

function showPopupMsg(msg){
    const bg = document.getElementById("popupBg");
    const p = document.getElementById("popup");
    p.innerHTML = `
        <h2>Aguarde!</h2>
        <p>${msg}</p>
        <button onclick="closePopup()">Fechar</button>
    `;
    bg.style.display = "flex";
}

function closePopup(){
    popupAudio.pause();
    popupAudio.currentTime = 0;
    restoreBgVolume();
    document.getElementById("popupBg").style.display = "none";
}

function generateCalendar(){
    for(let day=1; day<=TOTAL; day++){
        let format = formats[Math.floor(Math.random()*formats.length)];
        const el = createBox(day, format);
        grid.appendChild(el);
    }
}
generateCalendar();
</script>
</body>
</html>
